services:
  mapserver:
    image: thomasidgeo/mapserver-8.4  # Remplacez par votre image sur Docker Hub
    container_name: mapserver-apache-php
    ports:
      - "8080:80"
    volumes:
      # Configuration Apache
      - ./apache/sites-available:/etc/apache2/sites-available
      - ./apache/conf-available:/etc/apache2/conf-available
      
      # Logs Apache
      - ./logs:/var/log/apache2
      
      # Données MapServer
      - ./maps:/var/maps
      - ./maps/fonts:/var/maps/fonts
      - ./maps/icons:/var/maps/icons
      - ./mapfiles:/etc/mapserver
      - ./data:/var/mapserver/data

      # Fonts personnalisées
      - ./fonts:/usr/share/fonts/truetype/custom
      
      # Répertoire web
      - ./html:/var/www/html
      
      # Répertoire temporaire MapServer
      - ./tmp/ms_tmp:/tmp/ms_tmp
    
    environment:
      # Variables Apache
      - APACHE_RUN_USER=www-data
      - APACHE_RUN_GROUP=www-data
      - APACHE_LOG_DIR=/var/log/apache2
      - APACHE_SERVERADMIN=admin@localhost
      - APACHE_SERVERNAME=localhost
      - APACHE_SERVERALIAS=docker.localhost
      - APACHE_DOCUMENTROOT=/var/www/html

            # Variables MapServer
      - MS_MAPFILE=/etc/mapserver/carte.map
      - MS_MAP_PATTERN=^/etc/mapserver/.*\.map$$|^/var/www/html/.*\.map$$
      - MS_MAP_NO_PATH=1
      - MS_ERRORFILE=/tmp/ms_tmp/ms_error.log
      - MS_DEBUGLEVEL=2
      
      # Variables PROJ
      - PROJ_LIB=/usr/local/share/proj
      
      # Variables GDAL (optimisation)
      - GDAL_CACHEMAX=512
      - GDAL_DISABLE_READDIR_ON_OPEN=YES
      - CPL_VSIL_CURL_ALLOWED_EXTENSIONS=.tif,.tiff,.vrt
      - VSI_CACHE=TRUE
      - VSI_CACHE_SIZE=536870912
      
      # Locale et timezone
      - LANG=fr_FR.UTF-8
      - LC_ALL=fr_FR.UTF-8
      - TZ=Europe/Paris
      
      # Variables PHP (optionnelles)
      - PHP_MEMORY_LIMIT=256M
      - PHP_UPLOAD_MAX_FILESIZE=50M
      - PHP_POST_MAX_SIZE=50M
    
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      start_period: 40s
      retries: 3
    
    networks:
      - mapserver-network

networks:
  mapserver-network:
    driver: bridge